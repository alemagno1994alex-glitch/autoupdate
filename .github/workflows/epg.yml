name: Copia Periodica EPG

on:
  schedule:
    # ORA SOLARE (gen-mar, ott-dic): 00:00 italiana = 23:00 UTC (giorno prima)
    - cron: '30 20 * 1-3,10-12 *'
    - cron: '0 21 * 1-3,10-12 *'
    - cron: '30 21 * 1-3,10-12 *'
    # ORA LEGALE (apr-set): 00:00 italiana = 22:00 UTC (giorno prima)
    - cron: '0 17 * 4-9 *'
    - cron: '30 17 * 1-3,10-12 *'
  workflow_dispatch:

jobs:
  update-gist:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download M3U EPG
        id: download
        run: |
          # URL della playlist M3U
          URL="https://xromtv.com/canali-sky-xrom-italia-list-2026.json"
          
          echo "ğŸ”„ Download da: $URL"
          
          # Download del file M3U
          HTTP_CODE=$(curl -L -w "%{http_code}" -o sky_epg.m3u \
            --connect-timeout 30 \
            --max-time 120 \
            -H "User-Agent: Mozilla/5.0" \
            "$URL" 2>&1)
          
          # Verifica che il download sia riuscito
          if [ ! -s sky_epg.m3u ]; then
            echo "âŒ Download fallito (HTTP: $HTTP_CODE)"
            exit 1
          fi
          
          echo "âœ… Download completato"
          echo "ğŸ“Š Dimensione: $(wc -c < sky_epg.m3u) bytes"
          
          # Verifica che sia un file M3U valido
          if ! head -n 1 sky_epg.m3u | grep -q '^#EXTM3U'; then
            echo "âŒ Il file non Ã¨ un M3U valido"
            echo "ğŸ“„ Prime righe del file:"
            head -n 10 sky_epg.m3u
            exit 1
          fi
          
          # Conta i canali
          CHANNELS=$(grep -c '^#EXTINF' sky_epg.m3u || echo "0")
          echo "ğŸ“º Canali trovati: $CHANNELS"
          
          if [ "$CHANNELS" -eq 0 ]; then
            echo "âš ï¸  Nessun canale trovato nel file M3U"
            exit 1
          fi
          
          echo "âœ… File M3U valido con $CHANNELS canali"
          
      - name: Verifica modifiche e aggiorna solo se necessario
        run: |
          # Calcola hash del nuovo file
          NEW_HASH=$(sha256sum sky_epg.m3u | cut -d' ' -f1)
          echo "ğŸ” Hash nuovo file: $NEW_HASH"
          
          # Se esiste giÃ  un file, verifica se Ã¨ cambiato
          if [ -f sky_epg_backup.m3u ]; then
            OLD_HASH=$(sha256sum sky_epg_backup.m3u | cut -d' ' -f1)
            echo "ğŸ” Hash vecchio file: $OLD_HASH"
            
            if [ "$NEW_HASH" = "$OLD_HASH" ]; then
              echo "â­ï¸  Contenuto identico - NESSUN AGGIORNAMENTO necessario"
              exit 0
            else
              echo "ğŸ”„ Contenuto cambiato - Aggiornamento in corso..."
            fi
          else
            echo "ğŸ“ Primo download - Creazione backup..."
          fi
          
          # Verifica che il file non sia vuoto o corrotto
          CHANNELS=$(grep -c '^#EXTINF' sky_epg.m3u || echo "0")
          if [ "$CHANNELS" -lt 10 ]; then
            echo "âŒ File sospetto: solo $CHANNELS canali (troppo pochi)"
            echo "ğŸš« BLOCCO AGGIORNAMENTO per evitare sovrascrittura con file corrotto"
            exit 1
          fi
          
          # Backup del nuovo file
          cp sky_epg.m3u sky_epg_backup.m3u
          echo "âœ… File aggiornato e salvato"
          echo "ğŸ“º Totale canali nel nuovo file: $CHANNELS"
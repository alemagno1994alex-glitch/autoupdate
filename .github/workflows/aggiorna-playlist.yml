name: Aggiorna Playlist XromTV
on:
  schedule:
    # ORA SOLARE (gen-mar, ott-dic): UTC+1
    - cron: '15 11 * 1-3,10-12 *'  # 12:15 italiana â†’ 12:30 target
    - cron: '45 13 * 1-3,10-12 *'  # 14:45 italiana â†’ 15:00 target
    - cron: '45 16 * 1-3,10-12 *'  # 17:45 italiana â†’ 18:00 target
    - cron: '30 19 * 1-3,10-12 *'  # 20:30 italiana â†’ 20:45 target
    
    # ORA LEGALE (apr-set): UTC+2
    - cron: '15 10 * 4-9 *'  # 12:15 italiana â†’ 12:30 target
    - cron: '45 12 * 4-9 *'  # 14:45 italiana â†’ 15:00 target
    - cron: '45 15 * 4-9 *'  # 17:45 italiana â†’ 18:00 target
    - cron: '30 18 * 4-9 *'  # 20:30 italiana â†’ 20:45 target
  workflow_dispatch:

permissions:
  contents: read

jobs:
  update-playlist:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Debug - Info esecuzione
        run: |
          echo "ðŸ”„ ============ AGGIORNAMENTO PLAYLIST ============"
          echo "ðŸ“… Data/Ora italiana: $(TZ='Europe/Rome' date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "ðŸŒ Data/Ora UTC: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ðŸ“† Giorno: $(TZ='Europe/Rome' date '+%A')"
          echo "ðŸ“… Mese: $(TZ='Europe/Rome' date '+%B (%m)')"
          echo "âš™ï¸  Trigger: ${{ github.event_name }}"
          echo "=================================================="

      - name: Verifica orario valido
        id: verify_time
        run: |
          CURRENT_HOUR=$(TZ='Europe/Rome' date +%H)
          
          # Blocca esecuzione durante finestra reset (23:00-01:00)
          if [ "$CURRENT_HOUR" == "23" ] || [ "$CURRENT_HOUR" == "00" ]; then
            echo "â¸ï¸ Finestra di reset - aggiornamento saltato"
            echo "proceed=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "âœ… Orario valido per aggiornamento ($CURRENT_HOUR:xx)"
          echo "proceed=true" >> $GITHUB_OUTPUT

      - name: Scarica M3U esistente dal Gist
        if: steps.verify_time.outputs.proceed == 'true'
        id: download_existing
        continue-on-error: true
        run: |
          echo "ðŸ“¥ Download M3U esistente dal Gist..."
          
          GIST_URL="https://gist.githubusercontent.com/${{ github.repository_owner }}/${{ secrets.GIST_ID }}/raw/eventi.m3u"
          
          if curl -s -f -o existing.m3u "$GIST_URL"; then
            CHANNEL_COUNT=$(grep -c "^#EXTINF" existing.m3u 2>/dev/null || echo 0)
            echo "âœ… M3U esistente scaricato - Canali: $CHANNEL_COUNT"
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "existing_count=$CHANNEL_COUNT" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸ Nessun M3U esistente (probabilmente dopo reset)"
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "existing_count=0" >> $GITHUB_OUTPUT
            touch existing.m3u
          fi

      - name: Determina tipo operazione
        if: steps.verify_time.outputs.proceed == 'true'
        id: operation
        run: |
          CURRENT_HOUR=$(TZ='Europe/Rome' date +%H)
          EXISTING_COUNT=${{ steps.download_existing.outputs.existing_count }}
          
          if [ "$CURRENT_HOUR" == "12" ] && [ "$EXISTING_COUNT" == "0" ]; then
            echo "ðŸŒ… PRIMO CARICAMENTO della giornata"
            echo "type=first_load" >> $GITHUB_OUTPUT
          else
            echo "ðŸ”„ AGGIORNAMENTO normale"
            echo "type=update" >> $GITHUB_OUTPUT
          fi

      - name: Scarica playlist da XromTV (con fallback)
        if: steps.verify_time.outputs.proceed == 'true'
        id: download
        run: |
          # Lista URL da provare in ordine
          URLS=(
            "https://xromtv.com/italia/player/eventi.json"
            "https://xromtv.com/italia/player/eventi1.json"
            "https://xromtv.com/italia/player/eventi2.json"
            "https://xromtv.com/italia/player/eventi3.json"
          )
          
          MAX_RETRIES=2
          RETRY_DELAY=15
          SUCCESS=false
          USED_URL=""
          
          # Prova ogni URL
          for URL in "${URLS[@]}"; do
            echo ""
            echo "ðŸ”— Provo URL: $URL"
            
            for i in $(seq 1 $MAX_RETRIES); do
              echo "  ðŸ”„ Tentativo $i di $MAX_RETRIES..."
              
              HTTP_CODE=$(curl -s -o new_playlist.m3u -w "%{http_code}" \
                --connect-timeout 30 \
                --max-time 60 \
                -H "User-Agent: GitHubAction-PlaylistUpdater/1.0" \
                "$URL")
              
              if [ "$HTTP_CODE" = "200" ] && [ -s new_playlist.m3u ]; then
                # Verifica che contenga canali
                NEW_COUNT=$(grep -c "^#EXTINF" new_playlist.m3u 2>/dev/null || echo 0)
                
                if [ $NEW_COUNT -gt 0 ]; then
                  echo "  âœ… Download completato! (HTTP $HTTP_CODE - $NEW_COUNT canali)"
                  SUCCESS=true
                  USED_URL="$URL"
                  break 2  # Esce da entrambi i loop
                else
                  echo "  âš ï¸ File scaricato ma senza canali"
                fi
              elif [ "$HTTP_CODE" = "429" ]; then
                if [ $i -lt $MAX_RETRIES ]; then
                  echo "  â³ Rate limit - Attendo ${RETRY_DELAY}s..."
                  sleep $RETRY_DELAY
                else
                  echo "  âŒ Rate limit persistente"
                fi
              else
                echo "  âŒ Errore HTTP: $HTTP_CODE"
              fi
              
              # Pausa tra tentativi
              if [ $i -lt $MAX_RETRIES ]; then
                sleep 5
              fi
            done
            
            if [ "$SUCCESS" = true ]; then
              break
            fi
            
            # Pausa prima di provare il prossimo URL
            echo "  â­ï¸ Passo al prossimo URL..."
            sleep 5
          done
          
          # Verifica successo finale
          if [ "$SUCCESS" = false ]; then
            echo ""
            echo "âŒ ERRORE: Tutti gli URL hanno fallito!"
            echo "   URLs provati:"
            for URL in "${URLS[@]}"; do
              echo "   - $URL"
            done
            exit 1
          fi
          
          # Output risultati
          NEW_COUNT=$(grep -c "^#EXTINF" new_playlist.m3u 2>/dev/null || echo 0)
          echo ""
          echo "âœ… SUCCESSO!"
          echo "ðŸ“º Canali nella nuova playlist: $NEW_COUNT"
          echo "ðŸ”— URL utilizzato: $USED_URL"
          
          echo "new_count=$NEW_COUNT" >> $GITHUB_OUTPUT
          echo "used_url=$USED_URL" >> $GITHUB_OUTPUT

      - name: Processa e aggiorna playlist
        if: steps.verify_time.outputs.proceed == 'true'
        run: |
          OPERATION_TYPE="${{ steps.operation.outputs.type }}"
          EXISTING_COUNT="${{ steps.download_existing.outputs.existing_count }}"
          NEW_COUNT="${{ steps.download.outputs.new_count }}"
          USED_URL="${{ steps.download.outputs.used_url }}"
          
          echo ""
          echo "ðŸ“Š ELABORAZIONE:"
          echo "- Tipo: $OPERATION_TYPE"
          echo "- Canali esistenti: $EXISTING_COUNT"
          echo "- Canali nuovi: $NEW_COUNT"
          echo "- URL usato: $USED_URL"
          echo ""
          
          # Copia semplicemente la nuova playlist (contiene giÃ  tutto aggiornato)
          cp new_playlist.m3u merged.m3u
          
          # Salva statistiche
          echo "OLD_COUNT=$EXISTING_COUNT" >> $GITHUB_ENV
          echo "NEW_COUNT=$NEW_COUNT" >> $GITHUB_ENV
          echo "FINAL_COUNT=$NEW_COUNT" >> $GITHUB_ENV
          echo "OPERATION=$OPERATION_TYPE" >> $GITHUB_ENV
          echo "USED_URL=$USED_URL" >> $GITHUB_ENV
          
          # Verifica finale
          FINAL=$(grep -c "^#EXTINF" merged.m3u 2>/dev/null || echo 0)
          echo "âœ… RISULTATO FINALE:"
          echo "- Canali totali: $FINAL"
          echo "- Dimensione file: $(wc -c < merged.m3u) bytes"

      - name: Calcola hash e verifica cambiamenti
        if: steps.verify_time.outputs.proceed == 'true'
        id: check
        run: |
          NEW_HASH=$(sha256sum merged.m3u | awk '{print $1}')
          echo "ðŸ”¢ Hash nuovo: $NEW_HASH"
          
          # Ripristina hash precedente dalla cache
          OLD_HASH="none"
          if [ -f last_hash.txt ]; then
            OLD_HASH=$(cat last_hash.txt)
            echo "ðŸ”¢ Hash vecchio: $OLD_HASH"
          fi
          
          if [ "$NEW_HASH" != "$OLD_HASH" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âœ… Rilevati cambiamenti - Aggiornamento necessario"
            echo "$NEW_HASH" > last_hash.txt
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Nessun cambiamento - Skip aggiornamento"
          fi

      - name: Cache hash
        if: steps.verify_time.outputs.proceed == 'true'
        uses: actions/cache@v4
        with:
          path: last_hash.txt
          key: playlist-hash-${{ github.run_id }}
          restore-keys: playlist-hash-

      - name: Aggiorna Gist
        if: steps.verify_time.outputs.proceed == 'true' && steps.check.outputs.changed == 'true'
        uses: exuanbo/actions-deploy-gist@v1
        with:
          token: ${{ secrets.GIST_TOKEN }}
          gist_id: ${{ secrets.GIST_ID }}
          file_path: merged.m3u
          file_type: text

      - name: Riepilogo finale
        if: always()
        run: |
          echo "### ðŸ“Š Riepilogo Aggiornamento Playlist" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Parametro | Valore |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Ora (Italia)** | $(TZ='Europe/Rome' date '+%Y-%m-%d %H:%M:%S') |" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.verify_time.outputs.proceed }}" != "true" ]; then
            echo "| **Stato** | â¸ï¸ Saltato (finestra reset) |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| **Tipo** | ${OPERATION:-Aggiornamento} |" >> $GITHUB_STEP_SUMMARY
            echo "| **URL Usato** | ${USED_URL:-N/A} |" >> $GITHUB_STEP_SUMMARY
            echo "| **Canali Precedenti** | ${OLD_COUNT:-0} |" >> $GITHUB_STEP_SUMMARY
            echo "| **Canali Nuovi** | ${NEW_COUNT:-0} |" >> $GITHUB_STEP_SUMMARY
            echo "| **Canali Finali** | ${FINAL_COUNT:-0} |" >> $GITHUB_STEP_SUMMARY
            echo "| **Cambiamenti** | ${{ steps.check.outputs.changed == 'true' && 'âœ… SÃ¬' || 'â­ï¸ No' }} |" >> $GITHUB_STEP_SUMMARY
            echo "| **Gist Aggiornato** | ${{ steps.check.outputs.changed == 'true' && 'âœ… SÃ¬' || 'â­ï¸ No' }} |" >> $GITHUB_STEP_SUMMARY
            echo "| **Stato** | ${{ job.status == 'success' && 'âœ… OK' || 'âŒ Errore' }} |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**â° Prossimi aggiornamenti (ora italiana):**" >> $GITHUB_STEP_SUMMARY
          echo "- 12:30 - Primo caricamento giornaliero" >> $GITHUB_STEP_SUMMARY
          echo "- 15:00 - Aggiornamento pomeridiano" >> $GITHUB_STEP_SUMMARY
          echo "- 18:00 - Aggiornamento serale" >> $GITHUB_STEP_SUMMARY
          echo "- 20:45 - Aggiornamento finale" >> $GITHUB_STEP_SUMMARY
          echo "- 00:15 - Reset automatico" >> $GITHUB_STEP_SUMMARY
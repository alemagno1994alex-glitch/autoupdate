name: Aggiorna Playlist
on:
  schedule:
    # ORA SOLARE (gen-mar, ott-dic): UTC+1 → 09:00 italiana = 08:00 UTC
    - cron: '0 8 * 1-3,10-12 *'
    # ORA SOLARE (gen-mar, ott-dic): 22:15 italiana = 21:15 UTC
    - cron: '15 21 * 1-3,10-12 *'
    # ORA SOLARE (gen-mar, ott-dic): 24:30 italiana = 23:30   UTC
    - cron: '30 23 * 1-3,10-12 *'
    
    # ORA LEGALE (apr-set): UTC+2 → 09:00 italiana = 07:00 UTC
    - cron: '0 7 * 4-9 *'
     
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"
    
    - name: Install dependencies
      run: |
        pip install playwright requests
        playwright install chromium
    
    - name: Run merge script
      run: python merge.py
    
    - name: Update Gist
      env:
        GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
      run: |
        python3 -c '
        import json
        with open("solo_sky.m3u") as f:
            content = f.read()
        payload = {"files": {"solo_sky.m3u": {"content": content}}}
        with open("gist.json", "w") as f:
            json.dump(payload, f)
        '
        
        curl -X PATCH \
          -H "Authorization: token $GIST_TOKEN" \
          -H "Content-Type: application/json" \
          -d @gist.json \
          https://api.github.com/gists/b5a78b8c6e9d6e895c6ccbb030f565a2
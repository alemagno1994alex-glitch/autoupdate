name: Aggiorna Playlist
on:
  schedule:
    - cron: "0 9 * * *"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - uses: actions/setup-python@v4
      with:
        python-version: "3.11"
    
    - name: Install
      run: |
        pip install playwright requests
        playwright install chromium
    
    - name: Merge
      run: python merge.py
    
    - name: Upload Gist
      env:
        GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
      run: |
        python3 << 'EOF'
        import json
        with open("solo_sky.m3u") as f:
            content = f.read()
        payload = {"files": {"solo_sky.m3u": {"content": content}}}
        with open("gist.json", "w") as f:
            json.dump(payload, f)
        EOF
        
        curl -X PATCH \
          -H "Authorization: token $GIST_TOKEN" \
          -H "Content-Type: application/json" \
          -d @gist.json \
          https://api.github.com/gists/b5a78b8c6e9d6e895c6ccbb030f565a2
name: Aggiorna Playlist
on:
  schedule:
    # ORA SOLARE (gen-mar, ott-dic): UTC+1
    - cron: '15 10 * 1-3,10-12 *'  # 11:15 italiana
    - cron: '15 11 * 1-3,10-12 *'  # 12:15 italiana
    - cron: '15 12 * 1-3,10-12 *'  # 13:15 italiana
    - cron: '15 13 * 1-3,10-12 *'  # 14:15 italiana
    - cron: '15 14 * 1-3,10-12 *'  # 15:15 italiana
    - cron: '15 15 * 1-3,10-12 *'  # 16:15 italiana
    - cron: '15 16 * 1-3,10-12 *'  # 17:15 italiana
    - cron: '15 17 * 1-3,10-12 *'  # 18:15 italiana
    - cron: '15 18 * 1-3,10-12 *'  # 19:15 italiana
    - cron: '45 20 * 1-3,10-12 *'  # 21:45 italiana (ultimo aggiornamento)
    
    # ORA LEGALE (apr-set): UTC+2
    - cron: '15 9  * 4-9 *'  # 11:15 italiana
    - cron: '15 10 * 4-9 *'  # 12:15 italiana
    - cron: '15 11 * 4-9 *'  # 13:15 italiana
    - cron: '15 12 * 4-9 *'  # 14:15 italiana
    - cron: '15 13 * 4-9 *'  # 15:15 italiana
    - cron: '15 14 * 4-9 *'  # 16:15 italiana
    - cron: '15 15 * 4-9 *'  # 17:15 italiana
    - cron: '15 16 * 4-9 *'  # 18:15 italiana
    - cron: '15 17 * 4-9 *'  # 19:15 italiana
    - cron: '45 19 * 4-9 *'  # 21:45 italiana (ultimo aggiornamento)
  workflow_dispatch:

permissions:
  contents: read

jobs:
  update-playlist:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Debug - Info esecuzione
        run: |
          echo "ðŸ”„ ============ AGGIORNAMENTO PLAYLIST ============"
          echo "ðŸ“… Data/Ora italiana: $(TZ='Europe/Rome' date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "ðŸŒ Data/Ora UTC: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ðŸ“† Giorno: $(TZ='Europe/Rome' date '+%A')"
          echo "ðŸ“… Mese: $(TZ='Europe/Rome' date '+%B (%m)')"
          echo "âš™ï¸  Trigger: ${{ github.event_name }}"
          echo "=================================================="

      - name: Verifica orario valido
        id: verify_time
        run: |
          CURRENT_HOUR=$(TZ='Europe/Rome' date +%H)
          
          # Blocca esecuzione durante finestra reset (23:00-01:00)
          if [ "$CURRENT_HOUR" == "23" ] || [ "$CURRENT_HOUR" == "00" ]; then
            echo "â¸ï¸ Finestra di reset - aggiornamento saltato"
            echo "proceed=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "âœ… Orario valido per aggiornamento ($CURRENT_HOUR:xx)"
          echo "proceed=true" >> $GITHUB_OUTPUT

      - name: Test connettivitÃ  XromTV
        if: steps.verify_time.outputs.proceed == 'true'
        id: connectivity_test
        continue-on-error: true
        run: |
          echo "ðŸŒ Test connettivitÃ  al server XromTV..."
          
          if curl -I -s --connect-timeout 10 --max-time 20 https://xromtv.com/ | head -1; then
            echo "âœ… Server raggiungibile"
            echo "reachable=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Server non raggiungibile o lento"
            echo "reachable=false" >> $GITHUB_OUTPUT
          fi

      - name: Scarica M3U esistente dal Gist
        if: steps.verify_time.outputs.proceed == 'true'
        id: download_existing
        continue-on-error: true
        run: |
          echo "ðŸ“¥ Download M3U esistente dal Gist..."
          
          GIST_URL="https://gist.githubusercontent.com/${{ github.repository_owner }}/${{ secrets.GIST_ID }}/raw/eventi.m3u"
          
          if curl -s -f -o existing.m3u "$GIST_URL"; then
            CHANNEL_COUNT=$(grep -c "^#EXTINF" existing.m3u 2>/dev/null || echo 0)
            echo "âœ… M3U esistente scaricato - Canali: $CHANNEL_COUNT"
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "existing_count=$CHANNEL_COUNT" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸ Nessun M3U esistente (probabilmente dopo reset)"
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "existing_count=0" >> $GITHUB_OUTPUT
            touch existing.m3u
          fi

      - name: Determina tipo operazione
        if: steps.verify_time.outputs.proceed == 'true'
        id: operation
        run: |
          CURRENT_HOUR=$(TZ='Europe/Rome' date +%H)
          EXISTING_COUNT=${{ steps.download_existing.outputs.existing_count }}
          
          if [ "$CURRENT_HOUR" == "12" ] && [ "$EXISTING_COUNT" == "0" ]; then
            echo "ðŸŒ… PRIMO CARICAMENTO della giornata"
            echo "type=first_load" >> $GITHUB_OUTPUT
          else
            echo "ðŸ”„ AGGIORNAMENTO normale"
            echo "type=update" >> $GITHUB_OUTPUT
          fi

      - name: Scarica playlist da XromTV (con fallback migliorato)
        if: steps.verify_time.outputs.proceed == 'true'
        id: download
        run: |
          # Lista URL da provare in ordine
          URLS=(
            "https://xromtv.com/italia/player/eventi.json"
            "https://xromtv.com/italia/player/eventi1.json"
            "https://xromtv.com/italia/player/eventi2.json"
            "https://xromtv.com/italia/player/eventi3.json"
            "https://xromtv.com/italia/player/eventi4.json"
            "https://xromtv.com/italia/player/eventi"
            "https://xromtv.com/italia/player/eventi1"
            "https://xromtv.com/italia/player/eventi2"
            "https://xromtv.com/italia/player/eventi3"
            "https://xromtv.com/italia/player/eventi4"
          )
          
          MAX_RETRIES=3
          RETRY_DELAY=20
          SUCCESS=false
          USED_URL=""
          LAST_HTTP_CODE=""
          LAST_ERROR=""
          
          # Prova ogni URL
          for URL in "${URLS[@]}"; do
            echo ""
            echo "ðŸ”— Provo URL: $URL"
            
            for i in $(seq 1 $MAX_RETRIES); do
              echo "  ðŸ”„ Tentativo $i di $MAX_RETRIES..."
              
              # Download con maggiori dettagli
              HTTP_CODE=$(curl -s -o new_playlist.m3u -w "%{http_code}" \
                --connect-timeout 40 \
                --max-time 90 \
                -H "User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36" \
                -H "Accept: */*" \
                -H "Accept-Language: it-IT,it;q=0.9,en;q=0.8" \
                -H "Referer: https://xromtv.com/" \
                "$URL" 2>&1)
              
              LAST_HTTP_CODE="$HTTP_CODE"
              
              echo "  ðŸ“Š HTTP Code: $HTTP_CODE"
              
              if [ "$HTTP_CODE" = "200" ] && [ -s new_playlist.m3u ]; then
                # Verifica che contenga canali
                NEW_COUNT=$(grep -c "^#EXTINF" new_playlist.m3u 2>/dev/null || echo 0)
                FILE_SIZE=$(wc -c < new_playlist.m3u)
                
                echo "  ðŸ“¦ Dimensione file: $FILE_SIZE bytes"
                echo "  ðŸ“º Canali trovati: $NEW_COUNT"
                
                # Mostra prime righe per debug
                echo "  ðŸ“„ Prime 5 righe del file:"
                head -5 new_playlist.m3u | sed 's/^/     /'
                
                if [ $NEW_COUNT -gt 0 ]; then
                  echo "  âœ… Download completato! (HTTP $HTTP_CODE - $NEW_COUNT canali)"
                  SUCCESS=true
                  USED_URL="$URL"
                  break 2  # Esce da entrambi i loop
                else
                  LAST_ERROR="File scaricato ma senza canali validi (size: $FILE_SIZE)"
                  echo "  âš ï¸ $LAST_ERROR"
                fi
              elif [ "$HTTP_CODE" = "429" ]; then
                LAST_ERROR="Rate limit (HTTP 429)"
                echo "  âš ï¸ $LAST_ERROR"
                if [ $i -lt $MAX_RETRIES ]; then
                  echo "  â³ Attendo ${RETRY_DELAY}s prima di riprovare..."
                  sleep $RETRY_DELAY
                fi
              elif [ "$HTTP_CODE" = "000" ]; then
                LAST_ERROR="Timeout o errore di connessione"
                echo "  âŒ $LAST_ERROR"
              else
                LAST_ERROR="Errore HTTP: $HTTP_CODE"
                echo "  âŒ $LAST_ERROR"
                
                # Mostra eventuale contenuto di errore
                if [ -s new_playlist.m3u ]; then
                  echo "  ðŸ“„ Contenuto risposta:"
                  head -10 new_playlist.m3u | sed 's/^/     /'
                fi
              fi
              
              # Pausa tra tentativi
              if [ $i -lt $MAX_RETRIES ]; then
                sleep 8
              fi
            done
            
            if [ "$SUCCESS" = true ]; then
              break
            fi
            
            # Pausa prima di provare il prossimo URL
            echo "  â­ï¸ Passo al prossimo URL..."
            sleep 10
          done
          
          # Verifica successo finale
          if [ "$SUCCESS" = false ]; then
            echo ""
            echo "âŒ =========================================="
            echo "âŒ ERRORE: Tutti gli URL hanno fallito!"
            echo "âŒ =========================================="
            echo ""
            echo "ðŸ“‹ DETTAGLI DIAGNOSTICI:"
            echo "- Ultimo HTTP Code: $LAST_HTTP_CODE"
            echo "- Ultimo errore: $LAST_ERROR"
            echo "- Server raggiungibile: ${{ steps.connectivity_test.outputs.reachable }}"
            echo ""
            echo "ðŸ”— URLs provati:"
            for URL in "${URLS[@]}"; do
              echo "   - $URL"
            done
            echo ""
            echo "ðŸ’¡ POSSIBILI CAUSE:"
            echo "   1. XromTV temporaneamente offline"
            echo "   2. Cambio struttura URL/API"
            echo "   3. Blocco IP GitHub Actions"
            echo "   4. Rate limiting troppo aggressivo"
            echo ""
            
            # Salva info errore per il riepilogo
            echo "error_code=$LAST_HTTP_CODE" >> $GITHUB_OUTPUT
            echo "error_msg=$LAST_ERROR" >> $GITHUB_OUTPUT
            
            exit 1
          fi
          
          # Output risultati
          NEW_COUNT=$(grep -c "^#EXTINF" new_playlist.m3u 2>/dev/null || echo 0)
          echo ""
          echo "âœ… =========================================="
          echo "âœ… SUCCESSO!"
          echo "âœ… =========================================="
          echo "ðŸ“º Canali nella nuova playlist: $NEW_COUNT"
          echo "ðŸ”— URL utilizzato: $USED_URL"
          echo "ðŸ“¦ Dimensione: $(wc -c < new_playlist.m3u) bytes"
          
          echo "new_count=$NEW_COUNT" >> $GITHUB_OUTPUT
          echo "used_url=$USED_URL" >> $GITHUB_OUTPUT

      - name: Processa e aggiorna playlist
        if: steps.verify_time.outputs.proceed == 'true' && steps.download.outcome == 'success'
        run: |
          OPERATION_TYPE="${{ steps.operation.outputs.type }}"
          EXISTING_COUNT="${{ steps.download_existing.outputs.existing_count }}"
          NEW_COUNT="${{ steps.download.outputs.new_count }}"
          USED_URL="${{ steps.download.outputs.used_url }}"
          
          echo ""
          echo "ðŸ“Š ELABORAZIONE:"
          echo "- Tipo: $OPERATION_TYPE"
          echo "- Canali esistenti: $EXISTING_COUNT"
          echo "- Canali nuovi: $NEW_COUNT"
          echo "- URL usato: $USED_URL"
          echo ""
          
          # Copia semplicemente la nuova playlist (contiene giÃ  tutto aggiornato)
          cp new_playlist.m3u merged.m3u
          
          # Salva statistiche
          echo "OLD_COUNT=$EXISTING_COUNT" >> $GITHUB_ENV
          echo "NEW_COUNT=$NEW_COUNT" >> $GITHUB_ENV
          echo "FINAL_COUNT=$NEW_COUNT" >> $GITHUB_ENV
          echo "OPERATION=$OPERATION_TYPE" >> $GITHUB_ENV
          echo "USED_URL=$USED_URL" >> $GITHUB_ENV
          
          # Verifica finale
          FINAL=$(grep -c "^#EXTINF" merged.m3u 2>/dev/null || echo 0)
          echo "âœ… RISULTATO FINALE:"
          echo "- Canali totali: $FINAL"
          echo "- Dimensione file: $(wc -c < merged.m3u) bytes"

      - name: Calcola hash e verifica cambiamenti
        if: steps.verify_time.outputs.proceed == 'true' && steps.download.outcome == 'success'
        id: check
        run: |
          NEW_HASH=$(sha256sum merged.m3u | awk '{print $1}')
          echo "ðŸ”¢ Hash nuovo: $NEW_HASH"
          
          # Ripristina hash precedente dalla cache
          OLD_HASH="none"
          if [ -f last_hash.txt ]; then
            OLD_HASH=$(cat last_hash.txt)
            echo "ðŸ”¢ Hash vecchio: $OLD_HASH"
          fi
          
          if [ "$NEW_HASH" != "$OLD_HASH" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âœ… Rilevati cambiamenti - Aggiornamento necessario"
            echo "$NEW_HASH" > last_hash.txt
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Nessun cambiamento - Skip aggiornamento"
          fi

      - name: Cache hash
        if: steps.verify_time.outputs.proceed == 'true' && steps.download.outcome == 'success'
        uses: actions/cache@v4
        with:
          path: last_hash.txt
          key: playlist-hash-${{ github.run_id }}
          restore-keys: playlist-hash-

      - name: Aggiorna Gist
        if: steps.verify_time.outputs.proceed == 'true' && steps.check.outputs.changed == 'true'
        uses: exuanbo/actions-deploy-gist@v1
        with:
          token: ${{ secrets.GIST_TOKEN }}
          gist_id: ${{ secrets.GIST_ID }}
          file_path: merged.m3u
          file_type: text

      - name: Riepilogo finale
        if: always()
        run: |
          echo "### ðŸ“Š Riepilogo Aggiornamento Playlist" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Parametro | Valore |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Ora (Italia)** | $(TZ='Europe/Rome' date '+%Y-%m-%d %H:%M:%S') |" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.verify_time.outputs.proceed }}" != "true" ]; then
            echo "| **Stato** | â¸ï¸ Saltato (finestra reset) |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.download.outcome }}" == "failure" ]; then
            echo "| **Stato** | âŒ ERRORE DOWNLOAD |" >> $GITHUB_STEP_SUMMARY
            echo "| **HTTP Code** | ${{ steps.download.outputs.error_code }} |" >> $GITHUB_STEP_SUMMARY
            echo "| **Errore** | ${{ steps.download.outputs.error_msg }} |" >> $GITHUB_STEP_SUMMARY
            echo "| **Server Raggiungibile** | ${{ steps.connectivity_test.outputs.reachable }} |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "#### ðŸ” Diagnostica" >> $GITHUB_STEP_SUMMARY
            echo "- Verifica che XromTV.com sia online" >> $GITHUB_STEP_SUMMARY
            echo "- Controlla se gli URL sono cambiati" >> $GITHUB_STEP_SUMMARY
            echo "- Possibile blocco IP da GitHub Actions" >> $GITHUB_STEP_SUMMARY
          else
            echo "| **Tipo** | ${OPERATION:-Aggiornamento} |" >> $GITHUB_STEP_SUMMARY
            echo "| **URL Usato** | ${USED_URL:-N/A} |" >> $GITHUB_STEP_SUMMARY
            echo "| **Canali Precedenti** | ${OLD_COUNT:-0} |" >> $GITHUB_STEP_SUMMARY
            echo "| **Canali Nuovi** | ${NEW_COUNT:-0} |" >> $GITHUB_STEP_SUMMARY
            echo "| **Canali Finali** | ${FINAL_COUNT:-0} |" >> $GITHUB_STEP_SUMMARY
            echo "| **Cambiamenti** | ${{ steps.check.outputs.changed == 'true' && 'âœ… SÃ¬' || 'â­ï¸ No' }} |" >> $GITHUB_STEP_SUMMARY
            echo "| **Gist Aggiornato** | ${{ steps.check.outputs.changed == 'true' && 'âœ… SÃ¬' || 'â­ï¸ No' }} |" >> $GITHUB_STEP_SUMMARY
            echo "| **Stato** | âœ… OK |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**â° Prossimi aggiornamenti (ora italiana):**" >> $GITHUB_STEP_SUMMARY
          echo "- 11:15, 12:15, 13:15, 14:15, 15:15, 16:15, 17:15, 18:15, 19:15" >> $GITHUB_STEP_SUMMARY
          echo "- 21:45 - Aggiornamento finale" >> $GITHUB_STEP_SUMMARY
          echo "- 00:15 - Reset automatico" >> $GITHUB_STEP_SUMMARY
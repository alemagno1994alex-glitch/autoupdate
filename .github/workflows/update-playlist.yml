name: Aggiorna Playlist Gist

on:
  schedule:
    - cron: '0 */2 * * *' # Ogni 2 ore (12 volte al giorno)
  workflow_dispatch:

jobs:
  update-gist:
    runs-on: ubuntu-latest
    steps:
      - name: Scarica playlist dal Worker con retry
        run: |
          MAX_RETRIES=3
          RETRY_DELAY=30
          
          for i in $(seq 1 $MAX_RETRIES); do
            echo "üîÑ Tentativo $i di $MAX_RETRIES..."
            
            HTTP_CODE=$(curl -s -o playlists.json -w "%{http_code}" \
              -H "User-Agent: GitHubAction-PlaylistUpdater/1.0" \
              -H "Accept: application/json" \
              https://sport.alemagno1994alex.workers.dev)
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "‚úÖ Download completato con successo"
              break
            elif [ "$HTTP_CODE" = "429" ]; then
              echo "‚ö†Ô∏è Rate limit raggiunto (429)"
              if [ $i -lt $MAX_RETRIES ]; then
                echo "‚è≥ Attendo ${RETRY_DELAY} secondi prima di ritentare..."
                sleep $RETRY_DELAY
                RETRY_DELAY=$((RETRY_DELAY * 2)) # Backoff esponenziale
              else
                echo "‚ùå Tutti i tentativi falliti"
                exit 1
              fi
            else
              echo "‚ùå Errore HTTP: $HTTP_CODE"
              exit 1
            fi
          done

      - name: Verifica file scaricato
        run: |
          if [ ! -s playlists.json ]; then
            echo "‚ùå File playlists.json vuoto o non esistente"
            exit 1
          fi
          echo "üìä Dimensione file: $(wc -c < playlists.json) bytes"

      - name: Processa e crea M3U
        run: |
          cat playlists.json | jq -r '.[].text' > merged.m3u
          echo "üìù Righe M3U generate: $(wc -l < merged.m3u)"

      - name: Ripristina hash precedente dalla cache
        id: cache
        uses: actions/cache@v3
        with:
          path: last_hash.txt
          key: playlist-hash-${{ github.run_id }}
          restore-keys: |
            playlist-hash-

      - name: Calcola hash e verifica cambiamenti
        id: check
        run: |
          NEW_HASH=$(md5sum merged.m3u | awk '{print $1}')
          echo "üî¢ Nuovo hash: $NEW_HASH"
          
          if [ -f last_hash.txt ]; then
            OLD_HASH=$(cat last_hash.txt)
            echo "üî¢ Vecchio hash: $OLD_HASH"
          else
            OLD_HASH="none"
            echo "‚ÑπÔ∏è Primo run - nessun hash precedente"
          fi
          
          if [ "$NEW_HASH" != "$OLD_HASH" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Rilevati cambiamenti - Aggiornamento Gist..."
            echo "$NEW_HASH" > last_hash.txt
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è Nessun cambiamento - Skip aggiornamento"
          fi

      - name: Aggiorna Gist
        if: steps.check.outputs.changed == 'true'
        uses: exuanbo/actions-deploy-gist@v1
        with:
          token: ${{ secrets.GIST_TOKEN }}
          gist_id: ${{ secrets.GIST_ID }}
          file_path: merged.m3u
          file_type: text

      - name: Riepilogo finale
        if: always()
        run: |
          echo "### üìä Riepilogo Esecuzione" >> $GITHUB_STEP_SUMMARY
          echo "- **Hash playlist**: $(md5sum merged.m3u | awk '{print $1}')" >> $GITHUB_STEP_SUMMARY
          echo "- **Cambiamenti rilevati**: ${{ steps.check.outputs.changed }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

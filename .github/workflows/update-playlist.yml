name: Aggiorna Playlist Gist

on:
  schedule:
    - cron: '*/30 * * * *' # Controlla ogni 30 minuti
  workflow_dispatch: # Permette esecuzione manuale

jobs:
  update-gist:
    runs-on: ubuntu-latest
    steps:
      - name: Scarica playlist dal Worker
        run: |
          curl -o playlists.json https://sport.alemagno1994alex.workers.dev

      - name: Processa e crea M3U
        run: |
          cat playlists.json | jq -r '.[].text' > merged.m3u

      - name: Ripristina hash precedente dalla cache
        id: cache
        uses: actions/cache@v3
        with:
          path: last_hash.txt
          key: playlist-hash-${{ github.run_id }}
          restore-keys: |
            playlist-hash-

      - name: Calcola hash e verifica cambiamenti
        id: check
        run: |
          NEW_HASH=$(md5sum merged.m3u | awk '{print $1}')
          echo "new_hash=$NEW_HASH"
          
          if [ -f last_hash.txt ]; then
            OLD_HASH=$(cat last_hash.txt)
            echo "old_hash=$OLD_HASH"
          else
            OLD_HASH="none"
            echo "old_hash=none (primo run)"
          fi
          
          if [ "$NEW_HASH" != "$OLD_HASH" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "✅ Rilevati cambiamenti - Aggiornamento Gist..."
            echo "$NEW_HASH" > last_hash.txt
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "ℹ️ Nessun cambiamento - Skip aggiornamento"
          fi

      - name: Aggiorna Gist
        if: steps.check.outputs.changed == 'true'
        uses: exuanbo/actions-deploy-gist@v1
        with:
          token: ${{ secrets.GIST_TOKEN }}
          gist_id: ${{ secrets.GIST_ID }}
          file_path: merged.m3u
          file_type: text

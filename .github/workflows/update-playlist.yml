name: Aggiorna Playlist XromTV
on:
  schedule:
    # ORA SOLARE (gen-mar, ott-dic): UTC+1
    - cron: '30 11 * 1-3,10-12 *'  # 12:30 italiana
    - cron: '0 14 * 1-3,10-12 *'   # 15:00 italiana  
    - cron: '0 17 * 1-3,10-12 *'   # 18:00 italiana
    - cron: '45 19 * 1-3,10-12 *'  # 20:45 italiana
    - cron: '0 23 * 1-3,10-12 *'   # 00:00 italiana - reset
    
    # ORA LEGALE (apr-set): UTC+2
    - cron: '30 10 * 4-9 *'  # 12:30 italiana
    - cron: '0 13 * 4-9 *'   # 15:00 italiana
    - cron: '0 16 * 4-9 *'   # 18:00 italiana
    - cron: '45 18 * 4-9 *'  # 20:45 italiana
    - cron: '0 22 * 4-9 *'   # 00:00 italiana - reset
  workflow_dispatch:

permissions:
  contents: read

jobs:
  update-gist:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Debug - Mostra info esecuzione
        run: |
          echo "ðŸ” ============ DEBUG INFO ============"
          echo "ðŸ“… Data/Ora italiana: $(TZ='Europe/Rome' date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "ðŸŒ Data/Ora UTC: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ðŸ“† Giorno: $(TZ='Europe/Rome' date '+%A')"
          echo "ðŸ“… Mese: $(TZ='Europe/Rome' date '+%B (%m)')"
          echo "âš™ï¸  Trigger: ${{ github.event_name }}"
          echo "======================================"

      - name: Scarica M3U esistente dal Gist
        id: download_existing
        continue-on-error: true
        run: |
          echo "ðŸ“¥ Download M3U esistente dal Gist..."
          
          GIST_URL="https://gist.githubusercontent.com/${{ github.repository_owner }}/${{ secrets.GIST_ID }}/raw/eventi.m3u"
          
          if curl -s -f -o existing.m3u "$GIST_URL"; then
            CHANNEL_COUNT=$(grep -c "^#EXTINF" existing.m3u 2>/dev/null || echo 0)
            echo "âœ… M3U esistente scaricato - Canali: $CHANNEL_COUNT"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸ Nessun M3U esistente"
            echo "exists=false" >> $GITHUB_OUTPUT
            touch existing.m3u
          fi

      - name: Scarica playlist da XromTV
        id: download
        run: |
          MAX_RETRIES=3
          RETRY_DELAY=30
          
          for i in $(seq 1 $MAX_RETRIES); do
            echo "ðŸ”„ Tentativo $i di $MAX_RETRIES..."
            
            HTTP_CODE=$(curl -s -o new_playlist.m3u -w "%{http_code}" \
              --connect-timeout 30 \
              --max-time 60 \
              -H "User-Agent: GitHubAction-PlaylistUpdater/1.0" \
              https://xromtv.com/italia/player/eventi2)
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… Download completato"
              break
            elif [ "$HTTP_CODE" = "429" ]; then
              if [ $i -lt $MAX_RETRIES ]; then
                echo "â³ Attendo ${RETRY_DELAY}s..."
                sleep $RETRY_DELAY
                RETRY_DELAY=$((RETRY_DELAY * 2))
              else
                echo "âŒ Troppi tentativi"
                exit 1
              fi
            else
              echo "âŒ Errore HTTP: $HTTP_CODE"
              exit 1
            fi
          done
          
          # Verifica file
          if [ ! -s new_playlist.m3u ]; then
            echo "âŒ File vuoto"
            exit 1
          fi
          
          NEW_COUNT=$(grep -c "^#EXTINF" new_playlist.m3u 2>/dev/null || echo 0)
          echo "ðŸ“º Canali scaricati: $NEW_COUNT"
          
          if [ $NEW_COUNT -eq 0 ]; then
            echo "âŒ Nessun canale trovato"
            exit 1
          fi

      - name: Processa M3U
        run: |
          CURRENT_HOUR=$(TZ='Europe/Rome' date +%H)
          CURRENT_MINUTE=$(TZ='Europe/Rome' date +%M)
          
          echo "ðŸ• Ora italiana: ${CURRENT_HOUR}:${CURRENT_MINUTE}"
          
          # Conta canali esistenti
          EXISTING_COUNT=0
          if [ -s existing.m3u ]; then
            EXISTING_COUNT=$(grep -c "^#EXTINF" existing.m3u 2>/dev/null || echo 0)
          fi
          
          NEW_COUNT=$(grep -c "^#EXTINF" new_playlist.m3u 2>/dev/null || echo 0)
          
          # RESET A MEZZANOTTE
          if [ "$CURRENT_HOUR" == "00" ] && [ "$CURRENT_MINUTE" -lt "30" ]; then
            echo "ðŸŒ™ RESET MEZZANOTTE - Svuoto playlist"
            echo "#EXTM3U" > merged.m3u
            
            echo "OLD_COUNT=0" >> $GITHUB_ENV
            echo "NEW_ADDED=0" >> $GITHUB_ENV
            echo "FINAL_COUNT=0" >> $GITHUB_ENV
            echo "RESET=true" >> $GITHUB_ENV
            
          # PRIMO CARICAMENTO ALLE 12:30 (se vuota)
          elif [ "$CURRENT_HOUR" == "12" ] && [ $EXISTING_COUNT -eq 0 ]; then
            echo "ðŸŒ… PRIMO CARICAMENTO alle 12:30"
            cp new_playlist.m3u merged.m3u
            
            echo "OLD_COUNT=0" >> $GITHUB_ENV
            echo "NEW_ADDED=$NEW_COUNT" >> $GITHUB_ENV
            echo "FINAL_COUNT=$NEW_COUNT" >> $GITHUB_ENV
            echo "FIRST_LOAD=true" >> $GITHUB_ENV
            
          # AGGIORNAMENTO NORMALE
          else
            echo "ðŸ”„ AGGIORNAMENTO - Merge canali"
            
            # Copia semplicemente il nuovo file (contiene giÃ  tutto aggiornato)
            cp new_playlist.m3u merged.m3u
            
            echo "OLD_COUNT=$EXISTING_COUNT" >> $GITHUB_ENV
            echo "NEW_ADDED=$NEW_COUNT" >> $GITHUB_ENV
            echo "FINAL_COUNT=$NEW_COUNT" >> $GITHUB_ENV
            echo "UPDATE=true" >> $GITHUB_ENV
          fi
          
          # Verifica finale
          FINAL=$(grep -c "^#EXTINF" merged.m3u 2>/dev/null || echo 0)
          echo ""
          echo "ðŸ“Š RISULTATO:"
          echo "- Canali finali: $FINAL"
          echo "- Dimensione: $(wc -c < merged.m3u) bytes"

      - name: Calcola hash
        id: check
        run: |
          NEW_HASH=$(sha256sum merged.m3u | awk '{print $1}')
          echo "ðŸ”¢ Hash: $NEW_HASH"
          
          # Ripristina hash precedente
          OLD_HASH="none"
          if [ -f last_hash.txt ]; then
            OLD_HASH=$(cat last_hash.txt)
          fi
          
          if [ "$NEW_HASH" != "$OLD_HASH" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âœ… Rilevati cambiamenti"
            echo "$NEW_HASH" > last_hash.txt
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Nessun cambiamento"
          fi

      - name: Cache hash
        uses: actions/cache@v4
        with:
          path: last_hash.txt
          key: playlist-hash-${{ github.run_id }}
          restore-keys: playlist-hash-

      - name: Aggiorna Gist
        if: steps.check.outputs.changed == 'true'
        uses: exuanbo/actions-deploy-gist@v1
        with:
          token: ${{ secrets.GIST_TOKEN }}
          gist_id: ${{ secrets.GIST_ID }}
          file_path: merged.m3u
          file_type: text

      - name: Riepilogo
        if: always()
        run: |
          echo "### ðŸ“Š Riepilogo Esecuzione" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Parametro | Valore |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Ora (Italia)** | $(TZ='Europe/Rome' date '+%Y-%m-%d %H:%M:%S') |" >> $GITHUB_STEP_SUMMARY
          echo "| **Cambiamenti** | ${{ steps.check.outputs.changed == 'true' && 'âœ… SÃ¬' || 'â­ï¸ No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Stato** | ${{ job.status == 'success' && 'âœ… OK' || 'âŒ Errore' }} |" >> $GITHUB_STEP_SUMMARY
          
          if [ -f merged.m3u ]; then
            FINAL=$(grep -c "^#EXTINF" merged.m3u 2>/dev/null || echo 0)
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Canali totali: $FINAL**" >> $GITHUB_STEP_SUMMARY
            
            if [ "${RESET}" == "true" ]; then
              echo "- ðŸŒ™ Reset mezzanotte eseguito" >> $GITHUB_STEP_SUMMARY
            elif [ "${FIRST_LOAD}" == "true" ]; then
              echo "- ðŸŒ… Primo caricamento 12:30" >> $GITHUB_STEP_SUMMARY
            else
              echo "- ðŸ”„ Aggiornamento completato" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**â° Orari (ora italiana):**" >> $GITHUB_STEP_SUMMARY
          echo "- 12:30 - Primo caricamento" >> $GITHUB_STEP_SUMMARY
          echo "- 15:00, 18:00, 20:45 - Aggiornamenti" >> $GITHUB_STEP_SUMMARY
          echo "- 00:00 - Reset completo" >> $GITHUB_STEP_SUMMARY
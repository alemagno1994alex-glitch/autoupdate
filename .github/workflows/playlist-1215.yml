name: Aggiorna Playlist XromTV - 12:15

on:
  schedule:
    - cron: '15 11 * 1-3,10-12 *'  # Ora solare (UTC+1 â†’ 12:15 ITA)
    - cron: '15 10 * 4-9 *'        # Ora legale (UTC+2 â†’ 12:15 ITA)
  workflow_dispatch:

permissions:
  contents: read

jobs:
  update-gist:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Debug
        run: echo "Esecuzione alle 12:15 italiane"

      - name: Scarica playlist da XromTV
        run: |
          curl -s -o new_playlist.m3u \
            -H "User-Agent: GitHubAction-PlaylistUpdater/1.0" \
            https://xromtv.com/italia/player/eventi3
          [ -s new_playlist.m3u ] || { echo "âŒ Playlist vuota"; exit 1; }

      - name: Calcola hash
        id: check
        run: |
          NEW_HASH=$(sha256sum new_playlist.m3u | awk '{print $1}')
          OLD_HASH="none"
          [ -f last_hash.txt ] && OLD_HASH=$(cat last_hash.txt)
          if [ "$NEW_HASH" != "$OLD_HASH" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "$NEW_HASH" > last_hash.txt
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Cache hash
        uses: actions/cache@v4
        with:
          path: last_hash.txt
          key: playlist-hash-${{ github.run_id }}
          restore-keys: playlist-hash-

      - name: Aggiorna Gist
        if: steps.check.outputs.changed == 'true'
        uses: exuanbo/actions-deploy-gist@v1
        with:
          token: ${{ secrets.GIST_TOKEN }}
          gist_id: ${{ secrets.GIST_ID }}
          file_path: new_playlist.m3u
          file_type: text

      - name: Riepilogo
        run: |
          echo "### ðŸ“Š Riepilogo Esecuzione" >> $GITHUB_STEP_SUMMARY
          echo "| Ora (Italia) | $(TZ='Europe/Rome' date '+%Y-%m-%d %H:%M:%S') |" >> $GITHUB_STEP_SUMMARY
          echo "| Cambiamenti | ${{ steps.check.outputs.changed == 'true' && 'âœ… SÃ¬' || 'â­ï¸ No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Stato | ${{ job.status == 'success' && 'âœ… OK' || 'âŒ Errore' }} |" >> $GITHUB_STEP_SUMMARY
